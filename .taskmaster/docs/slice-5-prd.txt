# Slice 5: Health Intelligence & Recipe Catalog
## Product Requirements Document

**Version:** 1.0  
**Target Timeline:** 6-8 weeks  
**Estimated Tasks:** 15-20  
**Status:** Ready for task generation

---

## OVERVIEW

Slice 5 transforms Vanessa from a meal generator into a health-intelligent system. It integrates a comprehensive recipe database, multi-dimensional health scoring, diet profile support, and intelligent prep planning.

### The Four Major Systems

1. **Recipe Catalog System** - ~800 professionally-tested recipes from Spoonacular API
2. **Diet Compass Health Scoring** - 4-metric health evaluation for every recipe
3. **Diet Profiles System** - 11 preloaded dietary approaches with personalization
4. **Prep Planning System** - Day-specific prep capacity and AI-generated prep tasks

These systems work together to provide personalized, health-optimized meal plans that respect user constraints and cooking capacity.

---

## FEATURE 1: Spoonacular Recipe Database

### Goal
Build a comprehensive, health-scored recipe catalog that meal generation can pull from instead of always creating new recipes.

### User Stories
- "I want consistent, tested recipes instead of AI-generated ones every week"
- "I want to know which recipes are healthiest"
- "I want recipes that match my diet (Keto, Vegan, Mediterranean, etc.)"

### Technical Specification

**Source:** Spoonacular API (complexSearch endpoint)  
**Protocol:** `references/spoonacular-recipe-extraction-protocol.md`  
**Target:** ~800 unique recipes  
**Cost:** ~$29/month (Cook tier)

### Implementation Requirements

**Task 1: Spoonacular API Integration**
- Create API client wrapper
- Implement rate limiting (5 requests/second)
- Handle 429 responses with exponential backoff
- Cache all responses to avoid redundant calls
- Error handling for network failures

**Task 2: Recipe Extraction Script**
- Execute 66 systematic searches (protocol Section 3)
- Search categories:
  - 13 cuisine searches (Italian, Thai, Mediterranean, etc.)
  - 8 diet searches (Vegetarian, Vegan, Keto, Paleo, etc.)
  - 11 dish type searches (Soup, Salad, Bowl, Curry, etc.)
  - 10 protein searches (Chicken, Salmon, Tofu, Lentils, etc.)
  - 8 Diet Compass aligned (Omega-3 fish, Whole grains, etc.)
  - 3 meal slot searches (Breakfast, Snack, Appetizer)
  - 7 component searches (Sauces, Ferments, Stocks, etc.)
  - 3 effort level searches (Quick, Easy, Project)
  - 3 kid-friendly searches
- Deduplicate by Spoonacular ID (expect ~700-800 unique from targets)
- Progress tracking UI during extraction
- Save to: `vanessa_recipe_catalog`

**Task 3: Comprehensive Recipe Tagging**
- Apply tags from API responses (cuisines, diets, dishTypes)
- Infer additional tags from analysis:
  - cookingMethods: Parse instructions for keywords (grill, bake, roast, saut√©, etc.)
  - kidFriendly: Detect spicy/unfamiliar ingredients
  - carbBase: Identify primary carb (rice, pasta, potato, etc.)
  - spiceLevel: Analyze chili, jalape√±o, cayenne presence
  - makeAhead: Detect meal prep keywords in instructions
  - budgetTier: From pricePerServing (budget <$2, moderate $2-5, premium >$5)
  - effortLevel: From readyInMinutes (quick ‚â§20, easy 20-40, medium 40-60, project >60)
- Tag inference functions documented in protocol Section 4
- Store all tags in recipe.tags object

**Task 4: Nutrition Data Extraction**
- Extract from Spoonacular nutrition.nutrients array
- Map to our schema (macros, vitamins, minerals)
- Calculate per-serving values
- Handle missing omega-3 data (use reference values for fish)
- Store comprehensive nutrition object with each recipe

**Task 5: Image URL Construction**
- Spoonacular provides multiple image sizes via CDN
- Construct URLs for: thumbnail (90√ó90), small (240√ó150), medium (312√ó231), large (556√ó370)
- Store all sizes for responsive display
- Fallback to placeholder if image missing

**Task 6: Catalog Storage & Indexing**
- Store as JSON array in localStorage: `vanessa_recipe_catalog`
- Expected size: ~2-3MB for 800 recipes
- Build in-memory index for fast filtering:
  - By cuisine, diet, protein, effort level
  - By Diet Compass score ranges
  - By meal slot (breakfast, lunch, dinner)
- Cache indexes on load

**Task 7: Generation Integration**
- Update `/api/generate-meal-plan` to accept recipe catalog
- AI prompt: "PRIMARILY use recipes from provided catalog"
- Filter catalog by:
  - Diet profile compatibility
  - Meal slot (breakfast/lunch/dinner)
  - Prep level constraints
  - Personal exclusions
- Pass filtered catalog subset to Claude (reduce token usage)
- Generate new recipe ONLY if:
  - No catalog match for constraints
  - User specifically requested custom recipe
  - Requested amendment to existing recipe

**Data Structure:**
```javascript
// Recipe Catalog Entry (from Spoonacular)
{
  // Source & Identity
  recipeId: 'recipe_[uuid]',  // Our internal ID
  spoonacularId: 123456,      // Spoonacular's ID
  source: 'spoonacular',
  name: 'Chicken Tikka Masala',
  sourceUrl: 'https://...',
  
  // Media
  images: {
    thumbnail: 'https://spoonacular.com/.../90x90.jpg',
    small: 'https://.../240x150.jpg',
    medium: 'https://.../312x231.jpg',
    large: 'https://.../556x370.jpg'
  },
  
  // Recipe Data
  ingredients: [{name, quantity, unit, category, aisle}],
  steps: [{number, step, equipment, ingredients}],
  servings: 4,
  prepTime: 15,
  cookTime: 25,
  readyInMinutes: 40,
  
  // Nutrition (comprehensive)
  nutrition: {
    calories: 450,
    protein: 35,
    fat: 18,
    carbs: 32,
    fiber: 6,
    sugar: 8,
    saturatedFat: 4,
    omega3: 200,  // mg
    omega6: 800,
    sodium: 650,
    // ... 20+ nutrients total
  },
  
  // Tags (comprehensive)
  tags: {
    category: 'meal',
    cuisines: ['indian'],
    diets: ['gluten-free', 'high-protein'],
    dishTypes: ['curry', 'main-course'],
    mealSlots: ['lunch', 'dinner'],
    proteinSources: ['chicken'],
    cookingMethods: ['saut√©', 'simmer'],
    carbBases: ['rice'],
    effortLevel: 'easy',
    spiceLevel: 'medium',
    budgetTier: 'moderate',
    kidFriendly: false,
    makeAhead: true
  },
  
  // Quality Metrics
  spoonacularScore: 87,
  pricePerServing: 3.25,  // USD
  
  // Health Scoring (calculated, see Feature 2)
  dietCompassScores: {
    overall: 78,
    nutrientDensity: 82,
    antiAging: 75,
    weightLoss: 72,
    heartHealth: 84
  },
  
  // Provenance
  searchSource: 'CUI-02',  // Which search found this
  extractedAt: '2026-01-08T...',
  
  // Standard fields
  isFavorite: false,
  rating: null,
  timesCooked: 0,
  createdAt: '2026-01-08T...'
}
```

---

## FEATURE 2: Diet Compass Health Rating System

### Goal
Provide transparent, science-based health scoring for every recipe using principles from "The Diet Compass" by Bas Kast.

### User Stories
- "I want to know which recipes are healthiest"
- "I want to prioritize recipes good for weight loss"
- "I want to see which recipes are anti-inflammatory"
- "I want to understand the health impact of my weekly meal plan"

### Technical Specification

**Reference:** `references/diet-compass-health-rating-system.md`

**The Four Metrics:**

1. **Nutrient Density (0-100)**
   - Measures: Protective vs harmful foods proportion
   - Highly protective (Tier 1): Legumes (+20), Nuts (+18), Fatty fish (+20), Whole grains (+18)
   - Protective (Tier 2): Berries (+12), Leafy greens (+10), Olive oil (+12)
   - Harmful (Tier 4): Processed meat (-25), Red meat (-15), Refined grains (-10)
   - Base score: 50, apply bonuses/penalties, cap at 0-100

2. **Anti-Aging (0-100)**
   - Measures: Effects on cellular aging (mTOR, autophagy, inflammation)
   - Promoters: Olive oil (+15), Turmeric (+15), Fatty fish (+15), Aged cheese (+12)
   - Anti-inflammatory: Omega-3 fish (+15), Chia/flax (+12), Berries (+10)
   - Aging accelerators: Processed meat (-25), Red meat (-20), Added sugar (-15)
   - Protein source modifier: Plant-only (+15), Fish (+10), Red meat (-15)

3. **Weight Loss (0-100)**
   - Measures: Glycemic impact, satiety, insulin sensitivity
   - Low GI: Legumes (+15), Non-starchy vegetables (+12), Berries (+10)
   - High satiety: High fiber (+15), Adequate protein (+12), Healthy fats (+10)
   - High GI penalties: White potato (-15), White rice (-12), Added sugar (-20)
   - Caps: If added sugar >10g/serve, max score = 50

4. **Heart Health (0-100)**
   - Measures: Cardiovascular effects (omega-3, healthy fats, blood pressure)
   - Omega-3 rich: Salmon (+20), Sardines (+20), Walnuts (+15), Chia (+15)
   - Healthy fats: Olive oil (+15), Avocado (+12), Nuts (+10)
   - Blood pressure support: Leafy greens (+10), Beetroot (+10), Low sodium (+10)
   - Harmful: Trans fats (-30), Processed meat (-25), High sodium (-15)

**Overall Score:**
```
Overall = (Nutrient Density √ó 0.30) + (Anti-Aging √ó 0.25) + (Weight Loss √ó 0.25) + (Heart Health √ó 0.20)
```

### Implementation Requirements

**Task 8: Ingredient Health Database**
- Create `src/data/ingredientHealthData.json`
- Classify 200+ common ingredients
- Point values for each of 4 metrics
- Flags: isProcessed, isRedMeat, isProcessedMeat, containsTransFat
- Reference data from diet-compass-health-rating-system.md

**Task 9: Scoring Engine**
- File: `src/utils/dietCompassScoring.js`
- Functions:
  - `calculateRecipeScores(recipe)` ‚Üí returns all 4 scores + overall
  - `getIngredientHealthData(name)` ‚Üí lookup in database
  - `applyPortionMultipliers(points, quantity)` ‚Üí adjust for portion size
  - `applyScoreCaps(scores, flags)` ‚Üí enforce maximum caps
  - `generateHighlights(recipe, scores)` ‚Üí extract positive attributes
  - `generateImprovements(recipe, scores)` ‚Üí suggest enhancements
- Handle missing ingredients (default to neutral scoring)
- Round all scores to integers

**Task 10: Score Calculation for Catalog**
- Run scoring engine on all 800 catalog recipes during extraction
- Store scores in recipe.dietCompassScores
- Create score distribution report (how many recipes in each range)
- Identify top 50 highest-scoring recipes

**Task 11: Score Calculation for User Recipes**
- When user creates/imports recipe, calculate scores automatically
- Recalculate if recipe edited
- Show scores immediately after creation
- Store with recipe data

**Task 12: Visual Display Components**

**Component A: Recipe Detail Page Scores**
- Display location: Below recipe title, above ingredients
- Format:
  ```
  DIET COMPASS HEALTH SCORE
  Overall: 85 (Excellent)
  
  ü•ó Nutrient Density: 92
  ‚è≥ Anti-Aging: 78
  ‚öñÔ∏è Weight Loss: 82
  ‚ù§Ô∏è Heart Health: 88
  ```
- Add collapsible "Score Breakdown" section showing point attribution
- Add "Highlights" (positive attributes)
- Add "Improvement Suggestions" if score <80

**Component B: Recipe Card Health Bars**
- Display location: Under recipe name on card
- Format: 4 rows of icon + 5-segment bar
  ```
  Recipe Name
  [ü•ó ‚ñ†‚ñ†‚ñ†‚ñ†‚ñ°]  92 ‚Üí 5 bars (score 80-100)
  [‚è≥ ‚ñ†‚ñ†‚ñ†‚ñ°‚ñ°]  78 ‚Üí 4 bars (score 60-80)
  [‚öñÔ∏è ‚ñ†‚ñ†‚ñ†‚ñ†‚ñ°]  82 ‚Üí 5 bars
  [‚ù§Ô∏è ‚ñ†‚ñ†‚ñ†‚ñ†‚ñ°]  88 ‚Üí 5 bars
  ```
- Filled segments: Green (#22c55e)
- Empty segments: Light gray (#e5e7eb)
- Compact layout for grid view

**Component C: Meal Plan View Health Bars**
- Display location: Under each meal name in day cards
- Same format as recipe cards (4 icon + bar rows)
- Compact, mobile-responsive

**Score-to-Bar Conversion:**
| Score Range | Bars Filled |
|-------------|-------------|
| 0-20 | ‚ñ†‚ñ°‚ñ°‚ñ°‚ñ° (1/5) |
| 20-40 | ‚ñ†‚ñ†‚ñ°‚ñ°‚ñ° (2/5) |
| 40-60 | ‚ñ†‚ñ†‚ñ†‚ñ°‚ñ° (3/5) |
| 60-80 | ‚ñ†‚ñ†‚ñ†‚ñ†‚ñ° (4/5) |
| 80-100 | ‚ñ†‚ñ†‚ñ†‚ñ†‚ñ† (5/5) |

---

## FEATURE 3: Diet Profiles System

### Goal
Enable personalized meal planning based on established dietary approaches with room for individual customization.

### User Stories
- "I follow a Mediterranean diet and want meals that match"
- "My wife is Keto and I'm Vegan - we need different recipes sometimes"
- "I want Mediterranean diet but without eggplant and tomatoes"

### Technical Specification

**Reference:** `references/diet-profiles.md`

**11 Preloaded Profiles:**
1. Mediterranean - Heart-healthy, olive oil, fish, vegetables
2. Keto / Low-Carb - <50g carbs/day, high fat, moderate protein
3. Vegetarian - No meat/fish, includes dairy and eggs
4. High Protein - 25-35% protein, muscle building, satiety
5. Flexitarian - Mostly plant-based, occasional meat
6. Longevity Protocol - Based on Diet Compass book, evidence-based
7. Intermittent Fasting - Time-restricted eating (16:8, 18:6, etc.)
8. Vegan - No animal products, B12 supplementation
9. MIND - Brain health, cognitive function
10. Kid-Friendly - Ages 2-6, familiar foods, appropriate portions
11. La Dieta - Ceremonial preparation (ayahuasca), low tyramine

**Each Profile Includes:**
- Description (2-3 sentences)
- Key principles (bullet list)
- Foods to emphasize (categorized)
- Foods to avoid/minimize (categorized)
- Typical macros (% breakdown)
- Special considerations (health notes, warnings, compatibility)

### Implementation Requirements

**Task 13: Diet Profile Data Structure**
- Create `src/data/dietProfiles.json` with all 11 profiles
- JSON format matching profiles.md specifications
- Include: name, description, principles, emphasize, avoid, macros, considerations
- Compatibility matrix (which profiles can coexist, which conflict)

**Task 14: Profile Assignment in Onboarding**
- Enhance onboarding flow to ask about dietary preferences
- Questions:
  - "What do you value most in meals?" (health, convenience, ethics, performance)
  - "What do you like eating?" (open-ended)
  - "What would you prefer to avoid?" (open-ended)
- AI analyzes responses and suggests best-fit profile
- Vanessa says: "Based on what you've said, [Profile] seems to fit you well. We'll assign this diet profile with notes to [personalizations]. Does that sound good?"
- User confirms or chooses different profile
- Store: dietProfile + personalPreferences

**Task 15: Profile Settings UI**
- Location: Settings ‚Üí Household ‚Üí [Eater] ‚Üí Edit
- Add "Diet Profile" section:
  - Dropdown with 11 profiles + "None" option
  - Profile description shown on select (tooltip or below dropdown)
  - "Personal Preferences" subsection:
    - Foods to Exclude (tag chips with √ó to remove)
    - Foods to Prefer (tag chips)
    - Additional Notes (textarea)
- Auto-save on change
- Update eater in storage

**Task 16: Multi-Profile Meal Generation**
- Load all eaters eating this meal
- Extract diet profiles for each
- Check for conflicts using compatibility matrix
- If compatible: Filter catalog for recipes satisfying ALL profiles
- If conflicting: Generate separate recipe for each conflicting profile
- Pass filtered catalog + constraints to Claude
- Response includes targetEaters for each recipe

**Task 17: Multi-Recipe Meal Display**
- Enhance Meal component to support multiple recipes
- Display format when profiles conflict:
  ```
  Tuesday Dinner:
  - Dad: Tofu Buddha Bowl (Vegan)
  - Mom: Salmon with Asparagus (Keto)
  - Kids: Either option (Kid-Friendly compatible with both)
  ```
- Shopping list aggregates ALL recipes
- Each recipe shows Diet Compass scores

**Data Schema:**
```javascript
// Eater (enhanced)
{
  eaterId: 'eater_[uuid]',
  name: 'Roland',
  dietProfile: 'mediterranean' | 'keto' | 'vegetarian' | ... | null,
  personalPreferences: 'No eggplant, extra fish, high-protein dinners',
  excludeIngredients: ['eggplant', 'tomatoes', 'blue cheese'],
  preferIngredients: ['salmon', 'walnuts', 'dark chocolate'],
  allergies: ['shellfish'],  // Existing
  dietaryRestrictions: [],   // Existing
  // ... other existing fields
}

// Meal (for multi-profile support)
{
  mealId: 'meal_[uuid]',
  recipeId: 'recipe_[uuid]',  // Could be array: ['recipe_1', 'recipe_2'] if multiple
  mealType: 'breakfast' | 'lunch' | 'dinner',
  date: 'YYYY-MM-DD',
  eaterIds: ['eater_1', 'eater_2'],
  servings: 4,
  
  // NEW: Multi-recipe support
  recipes: [  // Array for conflicting profiles
    {
      recipeId: 'recipe_abc',
      targetEaters: ['Mom'],  // Who this recipe is for
      dietProfiles: ['keto'],
      servings: 1
    },
    {
      recipeId: 'recipe_def',
      targetEaters: ['Dad', 'Kids'],
      dietProfiles: ['vegan', 'kid-friendly'],
      servings: 3
    }
  ]
}
```

---

## FEATURE 4: Day Prep Section

### Goal
Show users exactly what they need to prep each day to execute their meal plan, respecting their available time and cooking capacity.

### User Stories
- "I want to see what I need to prep today before I start cooking"
- "I can only do simple assembly at lunch (workplace kitchen) - recipes should match"
- "On weekends I have more time to cook than weekdays"

### Technical Specification

### Implementation Requirements

**Task 18: Prep Level Settings UI**
- Location: Settings ‚Üí Meal Prep (new section/tab)
- Components:
  1. **Batch Prep Days Selector**
     - Multi-select checkboxes for all 7 days
     - Default: Saturday checked
     - Label: "Which days can you dedicate to batch meal prep?"
  
  2. **Prep Level Table**
     - 7 rows (days) √ó 3 columns (meal types) = 21 dropdown selectors
     - Each dropdown: Minimal / Medium / Full
     - Legend at top explaining each level:
       - **Minimal:** Simple assembly/heat (e.g., heat pre-cooked chicken, assemble salad)
       - **Medium:** Cooking 1-2 items (e.g., grill chicken breast, steam vegetables)
       - **Full:** Chopping, preparing multiple ingredients, extended cooking (e.g., chop vegetables, marinate, multi-step cooking)
  
  3. **Visual Design**
     - Table format with day names as row headers
     - Breakfast / Lunch / Dinner as column headers
     - Dropdown in each cell
     - Mobile: Collapsible accordions per day
     - Auto-save on change (300ms debounce)

- Store in: `baseSpecification.mealPrepSettings`

**Task 19: Prep Task Generation (AI)**
- Analyze each day's 3 recipes (breakfast, lunch, dinner)
- Extract prep tasks based on:
  - Recipe ingredients (what needs chopping, marinating, etc.)
  - Recipe instructions (identify prep steps)
  - User's prep level for that day/meal type
  - Batch opportunities (same ingredient used in multiple meals)
- Generate tasks with:
  - Task description ("Chop 2 onions, 1 bell pepper")
  - Estimated time (minutes)
  - Which meals use this prep
  - Timing (before_cooking, morning_of, day_before)
- Store in: `meal.prepTasks` array

**Task 20: DayView Prep Section**
- Add new section at TOP of DayView (before meals)
- Display:
  - "üìã Prep for Today" heading
  - Total estimated prep time (sum of all tasks)
  - List of prep tasks with:
    - Task description
    - Estimated time
    - Which meals benefit (‚Üí for lunch & dinner)
  - Visually distinct (border, background color)
- Collapsible on mobile to save space
- Show even if empty ("No prep needed today!")

**Task 21: Generation Prompt Enhancement**
- Include prep level constraints in system prompt
- For each meal, specify prep level
- Example: "Monday lunch: MINIMAL prep only (workplace - can only heat/assemble)"
- Claude generates/selects recipes matching prep constraints
- Recipes for MINIMAL prep:
  - Pre-cooked proteins, simple salads, sandwiches
  - Instructions focus on assembly, not cooking
  - Example: "Heat pre-cooked chicken, assemble bowl with greens, dressing"
- Recipes for FULL prep:
  - Multiple chopping tasks, complex assembly, extended cooking
  - Full instructions with all steps

**Data Schema:**
```javascript
// BaseSpecification.mealPrepSettings
{
  batchPrepDays: [6],  // Array of day indices (0=Sunday, 6=Saturday)
  prepLevels: {
    monday: {
      breakfast: 'minimal',
      lunch: 'minimal',
      dinner: 'medium'
    },
    tuesday: {
      breakfast: 'minimal',
      lunch: 'minimal',
      dinner: 'full'
    },
    // ... all 7 days
  }
}

// Meal.prepTasks (AI-generated)
[
  {
    task: 'Chop 2 onions, 1 bell pepper',
    estimatedTime: 10,  // minutes
    timing: 'before_cooking',
    usedIn: ['lunch', 'dinner']  // Shared prep
  },
  {
    task: 'Marinate chicken breast',
    estimatedTime: 5,
    timing: 'morning_of',  // Or 'day_before' for overnight marinades
    usedIn: ['dinner']
  }
]
```

**Default Prep Levels (First-Time Users):**
- Weekday breakfasts: Minimal
- Weekday lunches: Minimal
- Weekday dinners: Medium
- Weekend all meals: Full
- Batch prep day: Saturday

---

## FEATURE 5: Parent-Child Recipe System

### Goal
Track recipe variations elegantly, allowing users to browse substitutions and customizations while maintaining relationship to original recipes.

### User Stories
- "I want to make a vegetarian version of this beef recipe"
- "I want to see all the variations of this recipe I've tried"
- "I want to substitute zoodles for pasta and save that as a variation"

### Technical Specification

### Implementation Requirements

**Task 22: Recipe Relationship Schema**
- Add to Recipe:
  - `parentRecipeId: string | null` - Links to parent if this is a variation
  - `childRecipeIds: string[]` - Links to all children if this is a parent
  - `variationNote: string | null` - How this differs from parent
- Update storage functions to maintain relationships
- Prevent circular relationships (validation)

**Task 23: Create Variation Workflow**
- Add "Create Variation" button to RecipeDetailPage
- Opens RecipeEditPage with:
  - All fields pre-populated from parent
  - Recipe name suffix: " (Variation)" or user custom
  - parentRecipeId set to original recipe
- User edits ingredients, instructions, etc.
- On save:
  - Create new recipe with unique ID
  - Set parentRecipeId to original
  - Add child ID to parent's childRecipeIds array
  - Recalculate Diet Compass scores (variation may score different)
  - Save both parent and child
- Success: Navigate to new variation's detail page

**Task 24: Recipe Detail Page Enhancements**

**If recipe is PARENT (has children):**
- Add "Variations (X)" section below main recipe
- List all child recipes:
  - Recipe name (linked)
  - Variation note
  - Overall Diet Compass score (compare to parent)
  - "View" button
- Example:
  ```
  Variations (2):
  ‚îú‚îÄ Spaghetti Bolognese (Vegetarian) [Score: 85] "Lentils instead of beef"
  ‚îî‚îÄ Spaghetti Bolognese (Low Carb) [Score: 78] "Zoodles instead of pasta"
  ```

**If recipe is CHILD (has parent):**
- Add "Based on: [Parent Name]" link at top of page
- Show variation note prominently
- "View Original Recipe" button links to parent
- Compare scores: "This variation scores 10 points higher than original"

**Task 25: Recipe Library Variation Indicators**
- Recipe cards for parents show badge: "üîÄ Has variations (2)"
- Recipe cards for children show: "Based on: [Parent]"
- Filter option: "Show only original recipes" (hides children)

---

## FEATURE 6: Personal Preferences & Exclusions

### Goal
Allow fine-tuning of diet profiles with personal likes, dislikes, and preferences without creating entirely custom profiles.

### User Stories
- "I follow Mediterranean but hate eggplant and tomatoes"
- "I want extra servings of fish because I love it"
- "I prefer high-protein dinners even though my profile is balanced"

### Technical Specification

### Implementation Requirements

**Task 26: Preferences Data Model**
- Already defined in Eater schema (see above)
- Fields:
  - personalPreferences: string (free-text summary)
  - excludeIngredients: string[] (specific ingredients to avoid)
  - preferIngredients: string[] (ingredients to favor)
- Store with each eater
- Separate from base diet profile

**Task 27: Settings UI for Preferences**
- Location: Settings ‚Üí Household ‚Üí [Eater] ‚Üí Edit
- Below diet profile dropdown
- Components:
  - "Foods to Exclude" - Tag chip input
    - Type ingredient name, press Enter to add
    - Click √ó to remove
    - Placeholder: "Add foods you'd like to avoid..."
  - "Foods to Prefer" - Tag chip input
    - Same interaction pattern
    - Placeholder: "Add foods you'd like to prioritize..."
  - "Additional Notes" - Textarea
    - Free-form preferences
    - Placeholder: "E.g., prefer high-protein dinners, extra vegetables..."
- Auto-save all fields

**Task 28: Generation Integration**
- Pass to AI:
  - Base diet profile rules
  - Personal exclusions (hard constraints - NEVER use)
  - Personal preferences (soft constraints - TRY to include)
  - Additional notes (context for generation)
- Claude filters catalog recipes:
  - Must NOT contain excluded ingredients
  - Should contain preferred ingredients when possible
  - Respect both profile AND personal constraints
- Example prompt addition:
  ```
  Roland follows MEDITERRANEAN diet with these personalizations:
  - EXCLUDE: eggplant, tomatoes, blue cheese (never use these)
  - PREFER: salmon, walnuts, dark chocolate (include when possible)
  - NOTES: Prefer high-protein dinners
  ```

---

## INTEGRATION & GENERATION FLOW

### Enhanced Generation Process

**Step 1: Load User Context**
```javascript
// Gather all constraints
const eaters = loadEaters();  // Each has dietProfile, preferences, schedule
const baseSpec = loadBaseSpecification();  // Has mealPrepSettings
const catalog = loadRecipeCatalog();  // ~800 recipes with scores and tags
```

**Step 2: Filter Catalog per Meal**
```javascript
// For each meal (21 meals in week)
for (const meal of mealPlan) {
  const day = meal.date;  // Get day of week
  const mealType = meal.mealType;  // breakfast, lunch, dinner
  const eatersAtMeal = meal.eaterIds.map(id => findEater(id));
  
  // Get prep level for this specific day/meal
  const prepLevel = baseSpec.mealPrepSettings.prepLevels[day][mealType];
  
  // Get diet profiles for this meal
  const profiles = eatersAtMeal.map(e => e.dietProfile);
  
  // Check for conflicts
  if (hasProfileConflicts(profiles)) {
    // Generate separate recipes for conflicting profiles
    // Example: Keto + Vegan = 2 recipes needed
  } else {
    // Filter catalog for recipes compatible with ALL profiles
    const compatible = catalog.filter(recipe => 
      profiles.every(profile => 
        recipe.tags.diets.includes(profile)
      )
    );
    
    // Further filter by:
    // - Meal slot (breakfast recipes for breakfast)
    // - Prep level (minimal prep recipes for minimal capacity)
    // - Personal exclusions (no eggplant if user excludes it)
    // - Preferred ingredients (prioritize salmon if user prefers it)
    
    const filtered = compatible
      .filter(r => r.tags.mealSlots.includes(mealType))
      .filter(r => matchesPrepLevel(r, prepLevel))
      .filter(r => !containsExcludedIngredients(r, eatersAtMeal))
      .sort((a, b) => preferenceScore(b) - preferenceScore(a));  // Rank by preferences
  }
}
```

**Step 3: AI Selection/Generation**
```javascript
// Pass to Claude:
{
  catalogRecipes: filteredCatalog,  // Pre-filtered subset (not all 800)
  constraints: {
    eaters: [...],  // With profiles and preferences
    prepLevels: {...},  // Day-specific
    conflictingProfiles: true/false
  },
  instructions: "SELECT from catalog when possible. CREATE new recipe only if no catalog match."
}
```

**Step 4: Process Response**
```javascript
// Claude returns:
{
  meals: [
    {
      mealType: 'dinner',
      date: '2026-01-14',
      recipes: [  // Array for multi-profile support
        {
          recipeId: 'catalog_12345',  // From catalog
          fromCatalog: true,
          targetEaters: ['Dad', 'Kids'],
          dietProfiles: ['vegan', 'kid-friendly']
        },
        {
          // New generated recipe (no catalog match)
          fromCatalog: false,
          targetEaters: ['Mom'],
          dietProfiles: ['keto'],
          name: 'Keto Cauliflower Rice Bowl',
          ingredients: [...],
          instructions: '...'
        }
      ],
      prepTasks: [  // AI-generated based on prep level
        {
          task: 'Chop cauliflower into florets',
          estimatedTime: 10,
          timing: 'before_cooking',
          usedIn: ['dinner']
        }
      ]
    }
  ]
}

// Transform to our data model
// If recipe from catalog: Load full recipe data by ID
// If recipe is new: Calculate Diet Compass scores, assign ID, add to library
// Create Meal objects (potentially 2 per slot if conflicting profiles)
// Store prep tasks with each meal
```

---

## SYSTEM PROMPT ENHANCEMENTS

### Meal Plan Generation Prompt (Updated for Slice 5)

```
You are Vanessa, an expert meal planning assistant. Generate a complete 7-day meal plan.

HOUSEHOLD MEMBERS & DIET PROFILES:
- Roland: MEDITERRANEAN diet
  Exclude: eggplant, tomatoes, blue cheese
  Prefer: salmon, walnuts, dark chocolate
  Notes: Prefer high-protein dinners
  Schedule: Home for all meals

- Maya: KID-FRIENDLY diet (age 4)
  Exclude: spicy foods
  Schedule: Breakfast, dinner (not lunch - at daycare)

- Cathie: No specific profile
  Schedule: Dinner only (Mon-Thu), all meals (Fri-Sun)

MEAL PREP CAPACITY:
Monday:
  - Breakfast: MINIMAL (simple assembly/heat only)
  - Lunch: MINIMAL (workplace - can only heat)
  - Dinner: MEDIUM (can cook 1-2 items, 30 min)

Tuesday:
  - Breakfast: MINIMAL
  - Lunch: MINIMAL  
  - Dinner: FULL (time for extended cooking, chopping)

... (all 7 days)

Saturday = BATCH PREP DAY (can prep for upcoming week)

RECIPE SOURCES (800 recipes provided):
- PRIMARILY select from provided catalog recipes
- Filter by:
  - Diet profile compatibility (Mediterranean, Kid-Friendly)
  - Meal slot (breakfast recipes for breakfast)
  - Prep level (minimal/medium/full)
  - Personal exclusions (no eggplant, no tomatoes)
- PRIORITIZE recipes with preferred ingredients
- CREATE new recipe ONLY if:
  - No catalog recipe meets all constraints
  - User specifically requested it in chat
  - Profiles fundamentally conflict (see below)

DIET PROFILE CONFLICTS:
For Tuesday Dinner:
- Roland needs: MEDITERRANEAN compliant (no conflict with Kid-Friendly)
- Maya needs: KID-FRIENDLY compliant (no conflict with Mediterranean)
- SOLUTION: Find ONE recipe compatible with both profiles

For Wednesday Dinner:
- Roland needs: MEDITERRANEAN
- [Hypothetical] Mom needs: KETO
- CONFLICT DETECTED: Mediterranean (moderate-high carb) vs Keto (very low carb) = incompatible
- SOLUTION: Generate TWO separate recipes:
  - Recipe 1: Mediterranean Bowl (for Roland) - quinoa, chickpeas, vegetables
  - Recipe 2: Keto Salmon Plate (for Mom) - salmon, asparagus, olive oil, no grains

PREP TASK GENERATION:
For each recipe, based on meal's prep level:

MINIMAL prep meals:
- Use pre-cooked ingredients, simple assembly
- Prep tasks: Minimal or none
- Examples: "Heat pre-cooked chicken", "Assemble salad with pre-washed greens"
- Recipe instructions: 1-2 simple steps

MEDIUM prep meals:
- Cook 1-2 items, basic chopping
- Prep tasks: "Chop onion (5 min)", "Grill chicken (15 min)"
- Total prep+cook ‚â§ 30 minutes
- Recipe instructions: 3-5 steps

FULL prep meals:
- Multiple ingredients, complex assembly, extended cooking
- Prep tasks: "Chop 5 vegetables (15 min)", "Marinate chicken (5 min prep + 2hrs rest)"
- Total prep+cook: 45-60+ minutes
- Recipe instructions: 6-10+ steps

OUTPUT FORMAT:
{
  "meals": [
    {
      "mealType": "dinner",
      "date": "2026-01-14",
      "day": "Tuesday",
      "eaterIds": ["eater_1", "eater_2"],
      "eatersPresent": ["Roland", "Maya"],
      
      "recipes": [  // Array: could be 1 recipe (compatible) or 2+ (conflicts)
        {
          "recipeId": "catalog_12345",  // If using catalog
          "fromCatalog": true,
          "targetEaters": ["Roland", "Maya"],  // Who eats this recipe
          "dietProfiles": ["mediterranean", "kid-friendly"]
        }
        // OR if creating new:
        {
          "fromCatalog": false,
          "targetEaters": ["Roland"],
          "dietProfiles": ["mediterranean"],
          "name": "Mediterranean Quinoa Bowl",
          "ingredients": [...],
          "instructions": "...",
          "prepTime": 15,
          "cookTime": 20,
          "servings": 2
        }
      ],
      
      "prepTasks": [
        {
          "task": "Chop cucumber, tomatoes, red onion",
          "estimatedTime": 8,
          "timing": "before_cooking",
          "usedIn": ["dinner"]
        },
        {
          "task": "Cook quinoa",
          "estimatedTime": 15,
          "timing": "before_cooking",
          "usedIn": ["dinner"]
        }
      ],
      
      "totalPrepTime": 23  // Sum of prep task times
    }
  ]
}

CRITICAL REQUIREMENTS:
1. Use catalog recipes whenever possible (reduces token usage, consistent quality)
2. Respect ALL diet profiles for each meal
3. Generate separate recipes when profiles fundamentally conflict
4. Match prep level to user capacity (don't suggest complex cooking when only minimal capacity)
5. Generate specific prep tasks, not generic instructions
6. Ensure prep tasks are actionable and timed
```

---

## TESTING STRATEGY

### Unit Tests (New for Slice 5)
- Diet Compass scoring engine (test all 4 metrics)
- Ingredient database lookups
- Profile compatibility checking
- Catalog filtering algorithms
- Prep task extraction
- Parent-child relationship management

### Integration Tests
- Spoonacular extraction end-to-end
- Score calculation for 100+ diverse recipes
- Multi-profile meal generation
- Prep task generation for various levels
- Recipe variation creation workflow

### Manual Tests
- Onboarding with diet profile suggestion
- Setting prep levels (21 cells)
- Viewing health scores (bars on cards, numbers on detail)
- Creating recipe variation
- Generating meal plan with conflicting profiles
- Viewing prep section on day view
- Excluding ingredients and seeing them filtered

### Performance Tests
- Load time with 800-recipe catalog in localStorage
- Catalog filtering speed
- Score calculation time
- Mobile responsiveness with health bars

---

## SUCCESS CRITERIA

**Recipe Catalog:**
- ‚úÖ 700-800 unique recipes extracted
- ‚úÖ All have comprehensive nutrition data
- ‚úÖ All have Diet Compass scores
- ‚úÖ All properly tagged (10+ dimensions)
- ‚úÖ Catalog loads in <2 seconds
- ‚úÖ Filtering is instant

**Health Scoring:**
- ‚úÖ All recipes show Diet Compass scores
- ‚úÖ Visual bars accurate (score matches display)
- ‚úÖ Full detail page shows breakdown
- ‚úÖ Scores recalculated when recipe edited
- ‚úÖ Highlights and improvements generated

**Diet Profiles:**
- ‚úÖ 11 profiles available
- ‚úÖ Onboarding suggests profile accurately
- ‚úÖ Personal exclusions work (ingredients filtered)
- ‚úÖ Personal preferences prioritized
- ‚úÖ Multi-profile households generate correctly
- ‚úÖ Conflicting profiles show multiple recipes

**Prep Planning:**
- ‚úÖ Settings table works (21 cells functional)
- ‚úÖ Day view shows prep section first
- ‚úÖ Prep tasks relevant to capacity
- ‚úÖ Time estimates reasonable
- ‚úÖ Batch prep days identified

**Recipe Variations:**
- ‚úÖ Can create variation from any recipe
- ‚úÖ Parent-child links maintained
- ‚úÖ Variations displayed on parent
- ‚úÖ Scores recalculated for variations
- ‚úÖ No circular relationships possible

**Generation:**
- ‚úÖ Uses catalog primarily (>80% of recipes)
- ‚úÖ Creates new only when needed
- ‚úÖ Respects all diet constraints
- ‚úÖ Matches prep level requirements
- ‚úÖ Multi-recipe meals display correctly

---

## TECHNICAL DEBT & CONSIDERATIONS

**localStorage Size:**
- Catalog: ~2-3MB (800 recipes)
- Ingredient database: ~500KB (200+ ingredients)
- Current usage: ~1MB
- **New total: ~4-5MB / 5MB limit**
- **Risk:** Approaching localStorage quota
- **Mitigation:** 
  - Compress catalog data
  - Lazy-load images
  - Consider IndexedDB migration (25MB limit)
  - Future: Move catalog to Firebase (Slice 7)

**AI Token Usage:**
- Passing 800-recipe catalog to Claude = high token cost
- **Mitigation:** Pre-filter catalog to ~50-100 relevant recipes before passing
- Filter by: meal slot, diet profile, prep level
- Only pass subset that matches constraints

**Performance:**
- Filtering 800 recipes client-side
- **Mitigation:** Build indexes on load, use efficient filtering
- Test with 1000+ recipes to ensure scalability

**Complexity:**
- Slice 5 is largest slice (6 subsystems)
- High interdependency (profiles affect scoring affects display)
- **Mitigation:** Build and test each subsystem independently before integration

---

## DEPENDENCIES & BUILD ORDER

**Phase 1: Foundation (Week 1-2)**
1. Spoonacular extraction script
2. Recipe catalog storage
3. Ingredient health database
4. Diet profile data

**Phase 2: Scoring System (Week 2-3)**
5. Diet Compass scoring engine
6. Score calculation for catalog
7. Score display components (bars, full detail)

**Phase 3: Diet Profiles (Week 3-4)**
8. Profile assignment in onboarding
9. Profile settings UI
10. Personal preferences UI
11. Profile filtering logic

**Phase 4: Prep Planning (Week 4-5)**
12. Prep level settings UI
13. Prep task generation
14. Day view prep section
15. Generation prompt enhancement

**Phase 5: Variations (Week 5-6)**
16. Parent-child schema
17. Create variation workflow
18. Relationship display

**Phase 6: Integration (Week 6-8)**
19. Generation with catalog
20. Multi-profile handling
21. End-to-end testing
22. Performance optimization
23. Documentation

---

## DELIVERABLES

### Code
- 5,000-7,000 lines new code
- 10-15 new components/utilities
- 2-3 new API endpoints
- 1 extraction script
- Data files: 3 JSON databases (recipes, ingredients, profiles)

### Documentation
- Updated PRD with Slice 5 complete
- Spoonacular extraction report (coverage analysis)
- Diet Compass scoring validation report
- Migration guide (Slice 4 ‚Üí Slice 5)
- User guide for diet profiles and health scores

### Data
- ~800 recipes in catalog (JSON)
- 200+ ingredients in health database
- 11 diet profiles (JSON)
- Test data for all profiles

---

This PRD is ready for task generation. Expected output: 15-20 high-level tasks, 50-70 subtasks.
