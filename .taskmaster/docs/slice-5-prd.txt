# Product Requirements Document: Vanessa - SLICE 5 ONLY
# Health Intelligence & Recipe Catalog

## Project Context

**Product Name:** Vanessa - AI Meal Planning Concierge  
**Current Version:** v1.0-rc2 (Slice 4 Complete)  
**This Document:** Slice 5 Specification ONLY  
**Status:** Ready to generate tasks  
**Technology Stack:** Vanilla JavaScript, HTML, CSS (Tailwind), Vercel serverless functions, Claude API

---

## What's Been Built (Slices 1-4)

**Completed Features:**
- ‚úÖ Chat with Vanessa (conversational AI assistant)
- ‚úÖ Full meal plan generation (7 days, breakfast/lunch/dinner)
- ‚úÖ Recipe library (browsing, search, filter, favorites)
- ‚úÖ Onboarding flow (household setup, preferences)
- ‚úÖ Settings management
- ‚úÖ Recipe editing (full CRUD)
- ‚úÖ Recipe import from text (AI extraction)
- ‚úÖ Single-day regeneration (conversational workflow)
- ‚úÖ Meal plan history (archives with shopping lists)
- ‚úÖ Shopping list generation (categorized, consolidated)

**Current Data Model:**
- `Eater`: Household members with basic preferences
- `Recipe`: Name, ingredients, instructions, basic metadata
- `Meal`: Links recipe to date/mealType
- `MealPlan`: 7-day structure with shopping list
- `BaseSpecification`: User preferences, schedule, settings

---

## SLICE 5: Health Intelligence & Recipe Catalog

### Goal
Transform Vanessa from a meal generator into a health-intelligent system with comprehensive recipe database, nutritional scoring, diet profile support, and prep planning.

### Strategy
Slice 5 is the largest slice yet, establishing the foundation for health-conscious meal planning. It integrates six major subsystems that work together to provide personalized, health-optimized meal plans.

---

## Feature Overview

### **Feature 1: Recipe Database & Spoonacular Integration** üóÑÔ∏è

**User Value:** Access to ~800 professionally-tested recipes instead of AI-generated every time

**What It Builds:**
1. **Spoonacular API Integration**
   - Extract ~800 recipes using systematic search protocol
   - Full specification: `references/spoonacular-recipe-extraction-protocol.md`
   - Comprehensive tagging across all dimensions (cuisine, diet, protein, effort, etc.)
   - Includes nutrition data, images (multiple sizes), instructions

2. **Recipe Catalog Storage**
   - New localStorage key: `vanessa_recipe_catalog`
   - Indexed by Spoonacular ID for deduplication
   - Tagged across 10+ dimensions for intelligent filtering
   - Includes Diet Compass scoring for each recipe

3. **Catalog Management UI**
   - Admin/dev page to trigger extraction
   - Progress tracking during extraction
   - Gap analysis (identify missing coverage)
   - Manual recipe additions to catalog

**Technical Requirements:**
- API: `POST /api/extract-spoonacular-catalog` (bulk extraction endpoint)
- Extraction script: Execute 66 searches, deduplicate, tag, store
- Estimated API cost: ~$29/month (Cook tier) for extraction
- ~2-3MB storage for 800 recipes (JSON format)

**Generation Behavior Change:**
- **Primary:** Use catalog recipes (filter by constraints)
- **Fallback:** Generate new recipe if no catalog match
- **User Request:** Generate new if user specifically asks

---

### **Feature 2: Diet Compass Health Rating System** üìä

**User Value:** Understand health impact of every recipe across 4 key dimensions

**What It Builds:**
1. **4-Metric Scoring System**
   - Full specification: `references/diet-compass-health-rating-system.md`
   - Based on "The Diet Compass" by Bas Kast
   - Metrics:
     - **Nutrient Density** (0-100): Protective vs harmful foods
     - **Anti-Aging** (0-100): mTOR, autophagy, inflammation
     - **Weight Loss** (0-100): Glycemic impact, satiety, insulin
     - **Heart Health** (0-100): Omega-3, healthy fats, blood pressure
   - **Overall Score:** Weighted composite (0-100)

2. **Ingredient Database for Scoring**
   - Classify 200+ common ingredients by health impact
   - Point values for each metric
   - Portion-based multipliers
   - Score caps for particularly harmful ingredients

3. **Score Calculation Engine**
   - Calculate scores for all catalog recipes during extraction
   - Recalculate for user-created/imported recipes
   - Store scores with recipe data
   - Update scores if recipe is edited

4. **Visual Display Components**
   - **Recipe Detail Page:** Full metric names + actual scores
     - "Nutrient Density: 85"
     - "Anti-Aging: 72"
     - "Weight Loss: 68"
     - "Heart Health: 91"
   
   - **Recipe Cards (Library) & Meal Plan View:** Visual 5-bar system
     - Icon per metric: ü•ó ‚è≥ ‚öñÔ∏è ‚ù§Ô∏è
     - 5-segment bars (filled = green, empty = gray)
     - Score ranges: 0-20=1, 20-40=2, 40-60=3, 60-80=4, 80-100=5
     - Display under recipe title

**Technical Requirements:**
- Scoring engine: `src/utils/dietCompassScoring.js`
- Ingredient database: `src/data/ingredientHealthData.json`
- Visual components: Update RecipeDetailPage, RecipeCard, MealPlanView
- Storage: Add scores to Recipe schema

---

### **Feature 3: Diet Profiles System** ü•ó

**User Value:** Personalized meal plans based on established dietary approaches

**What It Builds:**
1. **10 Preloaded Diet Profiles**
   - Full specification: `references/diet-profiles.md`
   - Profiles:
     1. Mediterranean
     2. Keto / Low-Carb
     3. Vegetarian
     4. High Protein
     5. Flexitarian
     6. Longevity Protocol (Diet Compass-based)
     7. Intermittent Fasting
     8. Vegan
     9. MIND (brain health)
     10. Kid-Friendly
     11. La Dieta (ceremonial preparation)
   
   - Each includes: principles, foods to emphasize/avoid, macros, special considerations

2. **Profile Assignment in Onboarding**
   - AI asks about eating preferences and goals
   - Suggests best-fit preloaded profile
   - Example: "Based on what you've said, Mediterranean diet seems to fit you well. We'll assign this diet profile with notes to exclude eggplant and tomatoes. Does that sound good?"
   - Stores: Base profile + personal preferences/exclusions

3. **Profile Settings per Eater**
   - Each household member gets profile assignment
   - Dropdown selector in Settings ‚Üí Household ‚Üí [Eater]
   - Shows profile description on hover/select
   - Personal preferences field (additions to base profile)
   - Example: Profile = "Mediterranean", Preferences = "No eggplant, no blue cheese, extra fish"

4. **Multi-Profile Meal Generation**
   - AI attempts to accommodate ALL profiles at each meal
   - If fundamental conflicts exist (Keto + Vegan), generate multiple recipes
   - Display: Show each recipe separately with eater name
     ```
     Tuesday Dinner:
     - Dad: Tofu Stir Fry (Vegan)
     - Mom: Salmon with Asparagus (Keto)
     ```

**Data Schema Updates:**
```javascript
// Eater (enhanced)
{
  eaterId: 'eater_[uuid]',
  name: string,
  dietProfile: 'mediterranean' | 'keto' | 'vegetarian' | ... | null,
  personalPreferences: string,  // "No eggplant, extra fish"
  excludeIngredients: string[],  // ["eggplant", "tomatoes", "blue cheese"]
  allergies: string[],
  // ... existing fields
}

// Generation uses profile data to filter catalog and guide AI
```

**Technical Requirements:**
- Profile data: `src/data/dietProfiles.json`
- Profile selector component in SettingsPage
- Enhanced onboarding flow with profile suggestion
- Generation API: Filter catalog by profile compatibility
- Multi-recipe generation for conflicting profiles

---

### **Feature 4: Parent-Child Recipe System** üë®‚Äçüëß

**User Value:** Track recipe variations and substitutions elegantly

**What It Builds:**
1. **Recipe Relationship Schema**
   ```javascript
   {
     recipeId: 'recipe_[uuid]',
     name: 'Spaghetti Bolognese',
     parentRecipeId: null,  // This is a parent
     childRecipeIds: ['recipe_abc', 'recipe_def'],  // Links to children
     // ... rest of recipe
   }
   
   // Child recipe:
   {
     recipeId: 'recipe_abc',
     name: 'Spaghetti Bolognese (Vegetarian)',
     parentRecipeId: 'recipe_[uuid]',  // Links back to parent
     childRecipeIds: [],
     variationNote: 'Substituted lentils for beef',
     // ... rest of recipe
   }
   ```

2. **Recipe Detail Page Enhancement**
   - If parent: Show "Variations" section listing child recipes
   - If child: Show "Based on: [Parent Recipe Name]" link at top
   - Navigation between parent and children

3. **Amendment Workflow**
   - "Create Variation" button on RecipeDetailPage
   - Opens RecipeEditPage with pre-filled data
   - User edits ingredients/instructions
   - Save creates child recipe with parent link
   - Automatically names: "[Parent Name] (Variation)" or user custom

**Technical Requirements:**
- Update Recipe schema with parent/child fields
- "Create Variation" button and workflow
- RecipeDetailPage displays relationships
- Storage functions: `getRecipeFamily(recipeId)` returns parent + all children

---

### **Feature 5: Day Prep Section** üç≥

**User Value:** See at a glance what needs to be prepped today to execute meals

**What It Builds:**
1. **Prep Task Generation**
   - AI analyzes day's 3 recipes (breakfast, lunch, dinner)
   - Extracts prep tasks based on user's prep level settings
   - Considers:
     - User's prep capacity for this day/meal type
     - What can be prepped in advance vs day-of
     - Batch opportunities (prep for multiple meals)
     - Time constraints

2. **Day View Enhancement**
   - New "üìã Prep for Today" section at TOP of day view
   - Above Breakfast, Lunch, Dinner sections
   - Shows:
     - Prep task list with estimated times
     - Which meals each task supports
     - Total estimated prep time for the day
   
   **Example:**
   ```
   MONDAY, January 13
   
   üìã Prep for Today (~25 minutes)
   - Chop 2 onions, 1 bell pepper (10 min) ‚Üí for lunch & dinner
   - Marinate chicken breast (5 min, refrigerate 2 hours) ‚Üí for dinner
   - Cook 2 cups rice (10 min) ‚Üí for lunch
   
   üåÖ Breakfast: Oatmeal with berries
   üåû Lunch: Chicken stir fry
   üåô Dinner: Mediterranean bowl
   ```

3. **Prep Level Settings (Single-User MVP)**
   - Located in Settings ‚Üí Meal Prep
   - Day-specific table (7 days √ó 3 meals = 21 settings)
   
   **Table Format:**
   ```
   Prep Level Legend:
   - Minimal: Simple assembly/heat
   - Medium: Cooking one or two items
   - Full: Chopping, preparing multiple ingredients, extended cooking
   
           Breakfast    Lunch       Dinner
   Mon     [Minimal]    [Minimal]   [Medium]
   Tue     [Minimal]    [Minimal]   [Full]
   Wed     [Minimal]    [Minimal]   [Medium]
   Thu     [Minimal]    [Minimal]   [Full]
   Fri     [Medium]     [Medium]    [Full]
   Sat     [Full]       [Full]      [Full]
   Sun     [Full]       [Medium]    [Medium]
   
   Batch Prep Days: [‚òë Saturday] [‚òê Sunday] [‚òê Monday] ...
   ```

4. **AI Prompt Enhancement**
   - Include prep level constraints in generation prompt
   - Example: "Monday lunch needs minimal prep (workplace - can only heat)"
   - Claude generates recipes matching prep constraints
   - Prep tasks reflect actual user capacity

**Data Schema Updates:**
```javascript
// BaseSpecification (enhanced)
{
  // ... existing fields
  mealPrepSettings: {
    batchPrepDays: [6],  // Array of day indices (0=Sun, 6=Sat)
    prepLevels: {
      monday: { breakfast: 'minimal', lunch: 'minimal', dinner: 'medium' },
      tuesday: { breakfast: 'minimal', lunch: 'minimal', dinner: 'full' },
      // ... all 7 days
    }
  }
}

// Meal (enhanced)
{
  mealId: 'meal_[uuid]',
  recipeId: 'recipe_[uuid]',
  // ... existing fields
  prepTasks: [  // NEW: AI-generated prep tasks
    {
      task: 'Chop 2 onions, 1 bell pepper',
      estimatedTime: 10,  // minutes
      timing: 'before_cooking',  // or 'day_before', 'morning_of'
      usedIn: ['lunch', 'dinner']  // Which meals use this prep
    }
  ]
}
```

**Technical Requirements:**
- Settings page: Prep level table component
- AI prompt: Include prep constraints
- Prep task extraction from recipe instructions
- DayView: Prep section at top
- Storage: Save prep settings and tasks

**Future Enhancement (Slice 7 - Multi-User):**
- Each user has own prep settings
- Meals assigned to specific preparer
- Users see only their prep tasks
- Household coordination features

---

### **Feature 6: Personal Preferences & Exclusions** ‚öôÔ∏è

**User Value:** Fine-tune diet profiles with personal likes/dislikes

**What It Builds:**
1. **Preferences Data Structure**
   - Separate from base diet profile
   - Stored per eater
   - Categories:
     - Exclude ingredients (allergies, dislikes)
     - Prefer ingredients (favorites, extra servings)
     - Free-text notes

2. **Settings UI Enhancement**
   - In Settings ‚Üí Household ‚Üí [Eater] ‚Üí Edit
   - Below diet profile dropdown
   - Fields:
     - "Foods to Exclude" (comma-separated or tag chips)
     - "Foods to Prefer" (comma-separated or tag chips)
     - "Additional Notes" (textarea)

3. **Generation Integration**
   - Pass to AI: Base profile + personal preferences
   - Claude filters out excluded ingredients
   - Prioritizes preferred ingredients
   - Respects both profile rules AND personal preferences

**Example:**
```
Eater: Roland
Diet Profile: Mediterranean
Personal Preferences:
  - Exclude: eggplant, tomatoes, blue cheese
  - Prefer: extra fish, walnuts, dark chocolate
  - Notes: "Prefer dinner to be high-protein"
```

---

## End-to-End Flows

### **FLOW A: Onboarding with Diet Profile Assignment**
```
1. User opens app (first time)
2. Vanessa: "Let me learn about your eating preferences"
3. Vanessa asks: "What do you value in meals? What do you like eating? What would you prefer to avoid?"
4. User responds with preferences
5. Vanessa analyzes and suggests: "Based on what you've said, Mediterranean diet seems to fit you well. We'll assign this diet profile with notes to exclude eggplant and tomatoes. Does that sound good?"
6. User confirms
7. Profile saved: dietProfile="mediterranean", excludeIngredients=["eggplant","tomatoes"]
8. Continue onboarding (household members, budget, etc.)
```

### **FLOW B: Generating with Recipe Catalog**
```
1. User clicks "Generate Week"
2. System loads:
   - Household eaters with diet profiles
   - Recipe catalog (~800 recipes)
   - Prep level settings
   - Personal preferences
3. AI receives:
   - Catalog recipes (filtered by diet profiles)
   - Household schedule
   - Diet constraints
   - Prep constraints per day/meal
4. AI selects from catalog OR creates new if no match
5. For conflicting profiles (Keto + Vegan):
   - Generates 2 recipes for that meal
   - Labels each with eater name
6. Meal plan returned with:
   - Recipes (catalog or generated)
   - Diet Compass scores (pre-calculated for catalog)
   - Prep tasks per day
7. Display shows health scores under each recipe name
```

### **FLOW C: Viewing Day with Prep Section**
```
1. User clicks "Monday" from meal plan
2. DayView loads and displays:

   MONDAY, January 13
   
   üìã Prep for Today (~25 minutes)
   ‚îú‚îÄ Chop 2 onions, 1 bell pepper (10 min) ‚Üí for lunch & dinner
   ‚îú‚îÄ Marinate chicken (5 min) ‚Üí for dinner
   ‚îî‚îÄ Cook 2 cups rice (10 min) ‚Üí for lunch
   
   üåÖ Breakfast: Oatmeal with Berries
   [ü•ó ‚ñ†‚ñ†‚ñ†‚ñ†‚ñ°] [‚è≥ ‚ñ†‚ñ†‚ñ†‚ñ°‚ñ°] [‚öñÔ∏è ‚ñ†‚ñ†‚ñ†‚ñ†‚ñ°] [‚ù§Ô∏è ‚ñ†‚ñ†‚ñ†‚ñ†‚ñ°]
   
   üåû Lunch: Chicken Stir Fry
   [ü•ó ‚ñ†‚ñ†‚ñ†‚ñ†‚ñ†] [‚è≥ ‚ñ†‚ñ†‚ñ†‚ñ°‚ñ°] [‚öñÔ∏è ‚ñ†‚ñ†‚ñ†‚ñ†‚ñ°] [‚ù§Ô∏è ‚ñ†‚ñ†‚ñ†‚ñ†‚ñ†]
   
   üåô Dinner: Mediterranean Bowl
   [ü•ó ‚ñ†‚ñ†‚ñ†‚ñ†‚ñ†] [‚è≥ ‚ñ†‚ñ†‚ñ†‚ñ†‚ñ°] [‚öñÔ∏è ‚ñ†‚ñ†‚ñ†‚ñ†‚ñ°] [‚ù§Ô∏è ‚ñ†‚ñ†‚ñ†‚ñ†‚ñ†]

3. User sees prep needs first, then meals with health scores
```

### **FLOW D: Recipe Variation Creation**
```
1. User views "Spaghetti Bolognese" recipe detail
2. Clicks "Create Variation" button
3. RecipeEditPage opens with pre-filled data
4. User modifies: Replaces beef with lentils
5. Adds variation note: "Vegetarian version"
6. Saves as "Spaghetti Bolognese (Vegetarian)"
7. System creates:
   - New child recipe with unique ID
   - Links: parent ‚Üê ‚Üí child
8. Original recipe now shows "Variations (1)" section
9. Child recipe shows "Based on: Spaghetti Bolognese" at top
10. Diet Compass scores recalculated (vegetarian version likely scores higher)
```

### **FLOW E: Multi-Profile Household Generation**
```
Given:
- Mom: Keto diet profile
- Dad: Vegan diet profile
- Kids: Kid-Friendly profile

Tuesday Dinner (all three eating):
- AI analyzes: Keto + Vegan = fundamental conflict
- Generates 2 recipes:
  - Recipe 1: Salmon with Asparagus (Keto) ‚Üí for Mom
  - Recipe 2: Tofu Buddha Bowl (Vegan) ‚Üí for Dad
- Kids can eat either (Kid-Friendly allows both)
- Display shows both recipes separately with names
- Shopping list includes ingredients for BOTH recipes
```

---

## Data Schema Updates

### **Recipe (Enhanced for Slice 5)**
```javascript
{
  recipeId: 'recipe_[uuid]',
  name: string,
  
  // SOURCE & RELATIONSHIPS
  source: 'spoonacular' | 'generated' | 'user' | 'imported',
  spoonacularId: number | null,  // NEW: Link to Spoonacular
  parentRecipeId: 'recipe_[uuid]' | null,  // NEW: Parent-child relationships
  childRecipeIds: ['recipe_[uuid]'],  // NEW: List of variations
  variationNote: string | null,  // NEW: How this differs from parent
  
  // INGREDIENTS & INSTRUCTIONS
  ingredients: [
    {
      name: string,
      quantity: number,
      unit: string,
      category: 'produce' | 'meat' | 'dairy' | 'pantry' | 'other',
      healthImpact: 'protective' | 'neutral' | 'harmful'  // NEW: For scoring
    }
  ],
  instructions: string,
  prepTime: number,
  cookTime: number,
  servings: number,
  
  // HEALTH & NUTRITION
  dietCompassScores: {  // NEW: Full health scoring
    overall: number,  // 0-100
    nutrientDensity: number,
    antiAging: number,
    weightLoss: number,
    heartHealth: number
  },
  nutrition: {  // NEW: Comprehensive nutrition data
    calories: number,
    protein: number,
    fat: number,
    carbs: number,
    fiber: number,
    sugar: number,
    saturatedFat: number,
    omega3: number,
    omega6: number,
    sodium: number,
    // ... full nutrition profile
  },
  
  // TAGGING & FILTERING
  tags: {  // NEW: Comprehensive tagging
    cuisines: string[],
    diets: string[],  // Compatible diet profiles
    dishTypes: string[],
    mealSlots: string[],
    proteinSources: string[],
    cookingMethods: string[],
    carbBases: string[],
    effortLevel: 'quick' | 'easy' | 'medium' | 'project',
    spiceLevel: 'none' | 'mild' | 'medium' | 'hot',
    budgetTier: 'budget' | 'moderate' | 'premium',
    kidFriendly: boolean,
    makeAhead: boolean,
    protectiveFoods: string[]  // Which Diet Compass protective foods present
  },
  
  // EXISTING FIELDS
  isFavorite: boolean,
  rating: number | null,
  timesCooked: number,
  lastCooked: string | null,
  createdAt: string,
  updatedAt: string
}
```

### **Meal (Enhanced for Slice 5)**
```javascript
{
  mealId: 'meal_[uuid]',
  recipeId: 'recipe_[uuid]',
  mealType: 'breakfast' | 'lunch' | 'dinner',
  date: 'YYYY-MM-DD',
  eaterIds: string[],
  servings: number,
  notes: string,
  
  // NEW: Prep tasks for this meal
  prepTasks: [
    {
      task: string,  // "Chop 2 onions"
      estimatedTime: number,  // minutes
      timing: 'before_cooking' | 'day_before' | 'morning_of',
      usedIn: string[]  // Which meals use this prep (if shared)
    }
  ],
  
  // NEW: For multi-profile households
  targetEaters: string[],  // Specific eaters this recipe is for
  dietProfileTags: string[]  // Which profiles this recipe satisfies
}
```

### **BaseSpecification (Enhanced for Slice 5)**
```javascript
{
  _schemaVersion: 2,  // Bump version
  ownerEaterId: 'eater_[uuid]',
  weeklyBudget: number,
  shoppingDay: 0-6,
  preferredStore: string,
  maxShoppingListItems: number,
  householdEaterIds: string[],
  dietaryGoals: string,
  onboardingComplete: boolean,
  
  // NEW: Meal prep settings (single-user MVP)
  mealPrepSettings: {
    batchPrepDays: number[],  // [6] = Saturday
    prepLevels: {
      monday: { breakfast: 'minimal' | 'medium' | 'full', lunch: '...', dinner: '...' },
      tuesday: { breakfast: '...', lunch: '...', dinner: '...' },
      // ... all 7 days
    }
  },
  
  // EXISTING FIELDS
  weeklySchedule: {...},
  chatPreferences: {...},
  conversation: {...},
  historyRetentionWeeks: number,
  createdAt: string,
  updatedAt: string
}
```

### **Eater (Enhanced for Slice 5)**
```javascript
{
  eaterId: 'eater_[uuid]',
  name: string,
  
  // NEW: Diet profile system
  dietProfile: 'mediterranean' | 'keto' | 'vegetarian' | 'high-protein' | 
               'flexitarian' | 'longevity' | 'intermittent-fasting' | 'vegan' | 
               'mind' | 'kid-friendly' | 'la-dieta' | null,
  personalPreferences: string,  // "No eggplant, extra fish"
  excludeIngredients: string[],  // ["eggplant", "tomatoes"]
  preferIngredients: string[],   // ["salmon", "walnuts"]
  
  // EXISTING FIELDS
  allergies: string[],
  schedule: {...},
  createdAt: string,
  updatedAt: string
}
```

### **localStorage Keys (New in Slice 5)**
```javascript
'vanessa_recipe_catalog'      // Array of ~800 Spoonacular recipes
'vanessa_ingredient_health'   // Ingredient health scoring database
'vanessa_diet_profiles'       // 10 preloaded diet profile definitions
```

---

## Technical Implementation Details

### **1. Spoonacular Extraction Script**
**File:** `scripts/extractSpoonacularCatalog.js`  
**Purpose:** One-time extraction of ~800 recipes

**Process:**
1. Execute 66 searches from protocol (`references/spoonacular-recipe-extraction-protocol.md`)
2. Deduplicate by Spoonacular ID
3. Apply comprehensive tagging
4. Calculate Diet Compass scores
5. Transform to our Recipe schema
6. Save to catalog file
7. Generate coverage report

**Estimated Runtime:** 2-3 hours (rate limiting)

---

### **2. Diet Compass Scoring Engine**
**File:** `src/utils/dietCompassScoring.js`

**Functions:**
```javascript
// Calculate all 4 metric scores + overall
calculateRecipeScores(recipe) ‚Üí {
  overall: number,
  nutrientDensity: number,
  antiAging: number,
  weightLoss: number,
  heartHealth: number,
  breakdown: {...}  // Detailed point attribution
}

// Get ingredient health data
getIngredientHealthData(ingredientName) ‚Üí {
  nutrientDensityPoints: number,
  antiAgingPoints: number,
  weightLossPoints: number,
  heartHealthPoints: number,
  flags: {...}
}

// Convert score to bar segments (0-100 ‚Üí 1-5 bars)
scoreToBarSegments(score) ‚Üí number  // 1-5
```

---

### **3. Diet Profile Filter**
**File:** `src/utils/dietProfileFilter.js`

**Functions:**
```javascript
// Filter catalog recipes compatible with profile
filterByDietProfile(catalog, profileId) ‚Üí Recipe[]

// Check if recipe compatible with multiple profiles
isCompatibleWithProfiles(recipe, profileIds) ‚Üí boolean

// Detect fundamental conflicts
hasProfileConflicts(profileIds) ‚Üí {
  hasConflicts: boolean,
  conflictPairs: [['keto', 'vegan'], ...]
}
```

---

### **4. Prep Task Generator**
**File:** `src/utils/prepTaskGenerator.js`

**Functions:**
```javascript
// Generate prep tasks for a day based on recipes and prep levels
generateDayPrepTasks(dayRecipes, prepLevelSettings) ‚Üí PrepTask[]

// Analyze recipe for prep requirements
analyzeRecipePrepNeeds(recipe, prepLevel) ‚Üí PrepTask[]

// Identify batch prep opportunities
findBatchPrepOpportunities(weekRecipes, batchPrepDays) ‚Üí PrepTask[]
```

---

## Migration & Backward Compatibility

### **Data Migration (Slice 4 ‚Üí Slice 5)**

**Script:** `src/migrations/migrateToSlice5.js`

**Steps:**
1. **Add mealPrepSettings to BaseSpecification**
   - Default: All meals = 'medium', batchPrepDays = [6] (Saturday)

2. **Add dietProfile to each Eater**
   - Default: null (unassigned)
   - personalPreferences = "" (empty)
   - excludeIngredients = []
   - preferIngredients = []

3. **Enhance existing Recipe objects**
   - Add parentRecipeId = null
   - Add childRecipeIds = []
   - Add variationNote = null
   - Calculate Diet Compass scores for existing recipes
   - Add comprehensive tags
   - Add nutrition data (calculate if missing)

4. **Create new localStorage keys**
   - vanessa_recipe_catalog (empty initially)
   - vanessa_ingredient_health (from bundled data)
   - vanessa_diet_profiles (from bundled data)

5. **Update schema version**
   - BaseSpecification._schemaVersion = 2

**Backward Compatibility:**
- Existing recipes work without scores (scores = null)
- Existing meal plans display without prep section
- No data loss
- Gradual enhancement as features are used

---

## Success Criteria for Slice 5

### **Recipe Catalog:**
- ‚úÖ ~800 recipes extracted from Spoonacular
- ‚úÖ All recipes have comprehensive tags
- ‚úÖ All recipes have Diet Compass scores
- ‚úÖ All recipes have full nutrition data
- ‚úÖ Catalog searchable/filterable

### **Health Scoring:**
- ‚úÖ All recipes display Diet Compass scores
- ‚úÖ Visual bars work on cards and meal plan
- ‚úÖ Full scores on detail pages
- ‚úÖ Score calculation accurate and consistent

### **Diet Profiles:**
- ‚úÖ 11 preloaded profiles available
- ‚úÖ Onboarding suggests best-fit profile
- ‚úÖ Personal preferences stored separately
- ‚úÖ Generation respects profile constraints
- ‚úÖ Multi-profile households work (multiple recipes if needed)

### **Prep Planning:**
- ‚úÖ Users can set prep levels (day-specific, 21 settings)
- ‚úÖ Day view shows prep tasks at top
- ‚úÖ Prep tasks relevant to user's capacity
- ‚úÖ Estimated times shown
- ‚úÖ Batch prep days identified

### **Recipe Variations:**
- ‚úÖ Can create child recipes from parent
- ‚úÖ Parent-child links displayed
- ‚úÖ Variations browsable from parent
- ‚úÖ Diet Compass scores recalculated for children

### **Overall:**
- ‚úÖ Generation uses catalog primarily
- ‚úÖ Creates new recipes only when needed
- ‚úÖ Conflicting profiles handled gracefully
- ‚úÖ All health data accurate
- ‚úÖ Mobile-responsive
- ‚úÖ No performance degradation with large catalog

---

## What This Slice Does NOT Include (Deferred)

### **Deferred to Slice 6:**
- ‚ùå Multi-user accounts with individual logins
- ‚ùå Meal preparer assignment per meal
- ‚ùå User-specific prep task visibility
- ‚ùå Household coordination features

### **Deferred to Slice 7:**
- ‚ùå Firebase migration
- ‚ùå Multi-device sync
- ‚ùå Usage metering
- ‚ùå Cloud backup

### **Deferred to Slice 8+:**
- ‚ùå Community diet profile sharing
- ‚ùå Custom user-created diet profiles
- ‚ùå Nutrition goal tracking over time
- ‚ùå Advanced meal prep optimization (component reuse, batch cooking schedule)
- ‚ùå Export features (PDF, calendar sync)
- ‚ùå Pantry system integration

---

## Estimated Scope

### **Complexity Assessment:**
**Slice 5 is the LARGEST slice yet** ‚Äî encompasses 6 major subsystems working together.

**Estimated Tasks:** 15-20 tasks  
**Estimated Subtasks:** 50-70 subtasks  
**Estimated Timeline:** 6-8 weeks  
**Estimated Lines of Code:** 5,000-7,000 lines

**Breakdown:**
1. Spoonacular extraction: 1-2 weeks (script + API + storage)
2. Diet Compass scoring: 1-2 weeks (engine + display + testing)
3. Diet profiles: 1 week (data + UI + generation integration)
4. Prep planning: 1-2 weeks (settings + generation + display)
5. Parent-child recipes: 1 week (schema + UI + workflow)
6. Integration & testing: 1-2 weeks (gluing it all together)

**Risk Assessment:**
- **Medium Risk:** Large scope, many interdependencies
- **High Value:** Transforms app from basic generator to health intelligence system
- **Recommendation:** Build incrementally, test each subsystem independently

---

## Reference Documents

The following reference documents contain detailed specifications for Slice 5 features:

1. **`references/spoonacular-recipe-extraction-protocol.md`**
   - Complete protocol for extracting ~800 recipes from Spoonacular API
   - 66 systematic searches covering all cuisines, diets, proteins, etc.
   - Tagging strategy and deduplication logic

2. **`references/diet-compass-health-rating-system.md`**
   - Full specification of the 4-metric health scoring system
   - Ingredient database with health impact classifications
   - Scoring algorithm details for each metric
   - Visual display specifications

3. **`references/diet-profiles.md`**
   - Complete definitions of all 11 diet profiles
   - Principles, foods to emphasize/avoid, macros, special considerations
   - Profile compatibility matrix
   - Multi-profile conflict resolution strategies

These documents should be consulted during implementation for complete technical details.

---

**END OF SLICE 5 PRD**
